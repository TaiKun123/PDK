<div id="cartDrawer" class="cart-drawer">
    <div class="cart-header">
        <span class="cart-title">SHOPPING CART</span>
        <span class="cart-close" onclick="toggleCart()">✕</span>
    </div>
    
    <div class="cart-body" id="cartBody">
        <p style="margin-top: 50px;">您的購物車是空的</p>
    </div>

    <div class="cart-footer">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px; color:#fff;">
            <span>總計 Total</span>
            <span id="cartTotal">NT$ 0</span>
        </div>
        <button class="checkout-btn" onclick="window.location.href='/checkout'">前往結帳 CHECKOUT</button>
    </div>
</div>

<div id="quickViewModal" class="quick-view-modal">
    <div style="position:absolute; top:0; left:0; width:100%; height:100%; z-index:-1;" onclick="closeQuickView()"></div>
    <div class="modal-content">
        <span style="position:absolute; top:10px; right:15px; color:#fff; cursor:pointer; font-size:1.5rem; z-index:10;" onclick="closeQuickView()">✕</span>
        
        <div class="modal-split-layout">
            <div class="modal-left">
                <div id="modalImg" class="modal-img"></div>
            </div>

            <div class="modal-right">
                <div>
                    <h3 id="modalTitle" class="modal-title" style="margin-top:0; text-align:left;">商品名稱</h3>
                    <div id="modalPrice" class="modal-price" style="text-align:left;">NT$ 0</div>
                    <div id="modalDesc" class="modal-desc">特色說明載入中...</div>
                </div>

                <div class="qty-control-group" style="margin-top: 15px;">
                    <button class="qty-btn" onclick="adjustModalQty(-1)">-</button>
                    <div id="modalQtyDisplay" class="qty-display">1</div>
                    <button class="qty-btn" onclick="adjustModalQty(1)">+</button>
                </div>
            </div>
        </div>

        <div class="modal-bottom-action">
            <button class="checkout-btn" style="width:100%;" onclick="addToCartFromModal()">加入購物車 ADD TO CART</button>
        </div>
    </div>
</div>

<script>
    // 1. 初始化資料
    // 使用 let 確保全域可存取
    let cart = JSON.parse(localStorage.getItem('pdk_cart')) || [];
    let modalQty = 1; 
    let currentProduct = {};

    // 2. 載入完成更新畫面
    document.addEventListener('DOMContentLoaded', function() {
        updateCartUI();
        // 如果一進入頁面就想看到購物車內容，可以解除註解下行
        // renderCartItems(); 
    });

    // --- 功能 A: 小視窗邏輯 ---
    function openQuickView(id, name, price, desc) {
        currentProduct = { id: id, name: name, price: price };
        modalQty = 1; 
        document.getElementById('modalTitle').innerText = name;
        document.getElementById('modalPrice').innerText = 'NT$ ' + price.toLocaleString();
        document.getElementById('modalDesc').innerText = desc || "頂級沙龍專用配方，深層滋養您的秀髮。";
        document.getElementById('modalQtyDisplay').innerText = modalQty;

        let imgDiv = document.getElementById('modalImg');
        imgDiv.className = 'modal-img'; 
        imgDiv.classList.add('product-bg-' + id);
        document.getElementById('quickViewModal').classList.add('show');
    }

    function closeQuickView() {
        document.getElementById('quickViewModal').classList.remove('show');
    }

    function adjustModalQty(change) {
        modalQty += change;
        if(modalQty < 1) modalQty = 1; 
        document.getElementById('modalQtyDisplay').innerText = modalQty;
    }

    // --- 功能 B: 加入購物車 ---
    function addToCartFromModal() {
        let existingItem = cart.find(item => item.id === currentProduct.id);
        if (existingItem) {
            existingItem.qty += modalQty;
        } else {
            cart.push({
                id: currentProduct.id,
                name: currentProduct.name,
                price: currentProduct.price,
                qty: modalQty
            });
        }
        saveCart();
        updateCartUI();
        closeQuickView(); 

        // 震動回饋
        let cartIcon = document.querySelector('.cart-wrapper');
        if(cartIcon) {
            cartIcon.style.transform = 'scale(1.2)';
            setTimeout(() => { cartIcon.style.transform = 'scale(1)'; }, 200);
        }
    }

    // --- 功能 C: 購物車內的數量控制 ---
    function changeCartItemQty(id, change) {
        let item = cart.find(i => i.id === id);
        if (!item) return;
        item.qty += change;
        if (item.qty <= 0) {
            removeFromCart(id);
        } else {
            saveCart();
            updateCartUI();
            renderCartItems(); 
        }
    }

    function removeFromCart(id) {
        cart = cart.filter(item => item.id !== id);
        saveCart();
        updateCartUI();
        renderCartItems();
    }

    // --- 功能 D: 購物車開關 ---
    function toggleCart() {
        var drawer = document.getElementById('cartDrawer');
        var overlay = document.getElementById('menuOverlay');
        
        if (drawer.style.right === '0px') {
            drawer.style.right = '-400px';
            if(overlay) overlay.classList.remove('show');
        } else {
            drawer.style.right = '0px';
            if(overlay) {
                overlay.classList.add('show');
                overlay.onclick = function() { toggleCart(); }; 
            }
            renderCartItems(); 
        }
    }

    // --- 核心輔助 ---
    function saveCart() {
        localStorage.setItem('pdk_cart', JSON.stringify(cart));
    }

    function updateCartUI() {
        let totalQty = cart.reduce((sum, item) => sum + item.qty, 0);
        document.querySelectorAll('.cart-badge').forEach(b => b.innerText = totalQty);
        
        let totalPrice = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
        let totalEl = document.getElementById('cartTotal');
        if(totalEl) totalEl.innerText = 'NT$ ' + totalPrice.toLocaleString();
    }

    // --- 核心繪圖: 畫出購物車列表 ---
    function renderCartItems() {
        let cartBody = document.getElementById('cartBody');
        if (!cartBody) return;

        // 每次渲染前，確保變數跟 localStorage 同步
        cart = JSON.parse(localStorage.getItem('pdk_cart')) || [];
        
        if (cart.length === 0) {
            cartBody.innerHTML = '<p style="margin-top:50px; color:#666; text-align:center;">您的購物車是空的</p>';
            return;
        }

        let html = '';
        cart.forEach(item => {
            let decreaseBtnHtml = (item.qty > 1) 
                ? `<div class="cart-qty-btn" onclick="changeCartItemQty('${item.id}', -1)">-</div>`
                : `<div class="cart-qty-btn" onclick="removeFromCart('${item.id}')" style="font-size:0.8rem; color:#aaa;">✕</div>`;

            html += `
            <div class="cart-item" style="display:flex; margin-bottom:20px; text-align:left; border-bottom:1px solid #333; padding-bottom:15px;">
                <div class="product-bg-${item.id}" style="width:70px; height:70px; background-size:cover; background-position:center; margin-right:15px; border-radius:4px; flex-shrink:0;"></div>
                
                <div style="flex:1;">
                    <div style="color:#fff; font-size:0.9rem; margin-bottom:5px;">${item.name}</div>
                    <div style="color:#888; font-size:0.8rem;">NT$ ${item.price.toLocaleString()}</div>
                    
                    <div class="cart-qty-row" style="width:fit-content; margin-top:8px;">
                        ${decreaseBtnHtml}
                        <div class="cart-qty-num">${item.qty}</div>
                        <div class="cart-qty-btn" onclick="changeCartItemQty('${item.id}', 1)">+</div>
                    </div>
                </div>

                <div style="display:flex; flex-direction:column; justify-content:flex-end; align-items:flex-end;">
                    <span style="color:#fff; font-family:'Times New Roman';">NT$ ${(item.price * item.qty).toLocaleString()}</span>
                </div>
            </div>
            `;
        });
        cartBody.innerHTML = html;
    }

    // ★★★ 重要：新增全域接口，供 sh_001.html 等單品頁呼叫 ★★★
    window.externalCartUpdate = function() {
        // 1. 強制從 localStorage 更新變數
        cart = JSON.parse(localStorage.getItem('pdk_cart')) || [];
        // 2. 更新紅點數字與總金額
        updateCartUI();
        // 3. 重新畫出側邊欄列表內容
        renderCartItems();
    };
    // --- 功能 E: 處理瀏覽器「返回」鍵快取問題 ---
    // 當頁面顯示時（包含從快取中讀取的「返回」動作），強制同步購物車數據
    window.addEventListener('pageshow', function(event) {
        // 呼叫你寫好的全域更新接口
        if (typeof window.externalCartUpdate === 'function') {
            window.externalCartUpdate();
        }
    });
</script>